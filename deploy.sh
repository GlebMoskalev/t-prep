#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะดะตะฟะปะพั T-Prep ะฒ ะฟัะพะดะฐะบัะฝ

set -e

echo "๐ ะะตะฟะปะพะน T-Prep Backend"
echo "========================"

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะฟะพ ัะผะพะปัะฐะฝะธั
export POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-tprep_password}

echo "๐ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:"
echo "   POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}"

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะต ะบะพะฝัะตะนะฝะตัั
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะต ะบะพะฝัะตะนะฝะตัั..."
docker compose -f docker-compose.prod.yml down || true

# ะกะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั
echo "๐จ ะกะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
docker compose -f docker-compose.prod.yml up --build -d

# ะะดะตะผ ะณะพัะพะฒะฝะพััะธ ะฑะฐะทั ะดะฐะฝะฝัั
echo "โณ ะะถะธะดะฐะฝะธะต ะณะพัะพะฒะฝะพััะธ ะฑะฐะทั ะดะฐะฝะฝัั..."
sleep 10

# ะัะฟะพะปะฝัะตะผ ะผะธะณัะฐัะธะธ
echo "๐๏ธ  ะัะฟะพะปะฝัะตะผ ะผะธะณัะฐัะธะธ ะฑะฐะทั ะดะฐะฝะฝัั..."
./scripts/migrate-db.sh

# ะัะพะฒะตััะตะผ ัะฐะฑะพัั API
echo "๐ ะัะพะฒะตััะตะผ ัะฐะฑะพัั API..."
sleep 5

if curl -s http://localhost/health > /dev/null; then
    echo "โ API ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ!"
    echo "๐ ะะพัััะฟะฝะพ ะฟะพ ะฐะดัะตัั: http://localhost"
    echo "๐ ะกัะฐััั: http://localhost/health"
else
    echo "โ API ะฝะต ะพัะฒะตัะฐะตั"
    echo "๐ ะะพะณะธ ะบะพะฝัะตะนะฝะตัะพะฒ:"
    docker compose -f docker-compose.prod.yml logs web
    exit 1
fi

echo "๐ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ ััะฟะตัะฝะพ!"
