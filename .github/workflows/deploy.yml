name: Deploy to Ubuntu VM

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio httpx
    
    - name: Run tests
      run: |
        pytest tests/ -v || echo "No tests found, skipping..."
    
    - name: Lint with flake8
      run: |
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Linting completed"
    
    - name: Build Docker image
      run: |
        docker build -t ${{ env.IMAGE_NAME }}:test .

  validate-secrets:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate GitHub Secrets
      env:
        VM_HOST: ${{ secrets.VM_HOST }}
        VM_USERNAME: ${{ secrets.VM_USERNAME }}
        VM_SSH_KEY: ${{ secrets.VM_SSH_KEY }}
        VM_PORT: ${{ secrets.VM_PORT }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_REDIRECT_URI: ${{ secrets.GOOGLE_REDIRECT_URI }}
        ANDROID_CLIENT_ID: ${{ secrets.ANDROID_CLIENT_ID }}
        ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
        ALGORITHM: ${{ secrets.ALGORITHM }}
        ACCESS_TOKEN_EXPIRE_MINUTES: ${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}
        REFRESH_TOKEN_EXPIRE_DAYS: ${{ secrets.REFRESH_TOKEN_EXPIRE_DAYS }}
        DEBUG: ${{ secrets.DEBUG }}
        LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
        FCM_PROJECT_ID: ${{ secrets.FCM_PROJECT_ID }}
        FCM_SERVICE_ACCOUNT_JSON: ${{ secrets.FCM_SERVICE_ACCOUNT_JSON }}
      run: |
        echo "üîç –í–∞–ª–∏–¥–∞—Ü–∏—è GitHub Secrets..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã
        REQUIRED_SECRETS=(
          "VM_HOST" "VM_USERNAME" "VM_SSH_KEY" "VM_PORT"
          "POSTGRES_PASSWORD" "SECRET_KEY"
          "GOOGLE_CLIENT_ID" "GOOGLE_CLIENT_SECRET" "GOOGLE_REDIRECT_URI"
          "ANDROID_CLIENT_ID" "ALLOWED_ORIGINS"
        )
        
        MISSING_SECRETS=()
        for secret in "${REQUIRED_SECRETS[@]}"; do
          if [ -z "${!secret}" ]; then
            MISSING_SECRETS+=("$secret")
          else
            echo "‚úÖ $secret - OK"
          fi
        done
        
        if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
          echo "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–µ–∫—Ä–µ—Ç—ã: ${MISSING_SECRETS[*]}"
          exit 1
        fi
        
        # DATABASE_URL —Ç–µ–ø–µ—Ä—å —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ Docker, –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞
        
        if [[ ! "$GOOGLE_REDIRECT_URI" =~ ^https?:// ]]; then
          echo "‚ùå GOOGLE_REDIRECT_URI –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º URL"
          exit 1
        fi
        
        if [ ${#SECRET_KEY} -lt 32 ]; then
          echo "‚ùå SECRET_KEY –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 32 —Å–∏–º–≤–æ–ª–æ–≤"
          exit 1
        fi
        
        echo "üéâ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ!"

  deploy:
    needs: [test, validate-secrets]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to Ubuntu VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: ${{ secrets.VM_PORT }}
        script: |
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          cd /opt/t-prep
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          docker compose down || true
          
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git fetch origin
          git reset --hard origin/main || git reset --hard origin/master
          
          # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –∏–∑ —à–∞–±–ª–æ–Ω–∞
          echo "üìù –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –∏–∑ GitHub Secrets..."
          
          # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–∑ GitHub Secrets
          cat > .env << EOF
          # Database
          # DATABASE_URL —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ docker-compose.prod.yml
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          
          # JWT
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ALGORITHM=${{ secrets.ALGORITHM || 'HS256' }}
          ACCESS_TOKEN_EXPIRE_MINUTES=${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES || '30' }}
          REFRESH_TOKEN_EXPIRE_DAYS=${{ secrets.REFRESH_TOKEN_EXPIRE_DAYS || '7' }}
          
          # Google OAuth (Web)
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI=${{ secrets.GOOGLE_REDIRECT_URI }}
          
          # Google OAuth (Android)
          ANDROID_CLIENT_ID=${{ secrets.ANDROID_CLIENT_ID }}
          
          # App settings
          DEBUG=${{ secrets.DEBUG || 'False' }}
          ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}
          
          # Logging
          LOG_LEVEL=${{ secrets.LOG_LEVEL || 'INFO' }}
          
          # FCM (Firebase Cloud Messaging)
          FCM_PROJECT_ID=${{ secrets.FCM_PROJECT_ID }}
          EOF
          
          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ FCM –∏–∑ —Å–µ–∫—Ä–µ—Ç–∞
          if [ -n "${{ secrets.FCM_SERVICE_ACCOUNT_JSON }}" ]; then
            cat > /opt/t-prep/fcm-service-account.json << 'FCMEOF'
          ${{ secrets.FCM_SERVICE_ACCOUNT_JSON }}
          FCMEOF
            echo "FCM_SERVICE_ACCOUNT_FILE=/opt/t-prep/fcm-service-account.json" >> .env
            echo "‚úÖ FCM service account —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω"
          fi
          
          echo "‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏–∑ GitHub Secrets"
          
          # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          docker compose -f docker-compose.prod.yml pull
          docker compose -f docker-compose.prod.yml build --no-cache
          docker compose -f docker-compose.prod.yml up -d
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
          sleep 15
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          echo "üîÑ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
          ./scripts/migrate-db.sh || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          docker compose -f docker-compose.prod.yml ps
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ API
          curl -f http://localhost:8000/health || echo "API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Notify deployment status
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "üéâ –î–µ–ø–ª–æ–π –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ!"
        else
          echo "‚ùå –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
        fi
