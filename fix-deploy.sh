#!/bin/bash

# ะััััะพะต ะธัะฟัะฐะฒะปะตะฝะธะต ะดะปั ะดะตะฟะปะพั ะฝะฐ VM
# ะญัะพั ัะบัะธะฟั ะผะพะถะฝะพ ะทะฐะฟัััะธัั ะฝะฐ VM ะดะปั ะธัะฟัะฐะฒะปะตะฝะธั ะฟัะพะฑะปะตะผั ั ะฟะฐัะพะปะตะผ

set -e

echo "๐ง ะััััะพะต ะธัะฟัะฐะฒะปะตะฝะธะต ะดะตะฟะปะพั ะฝะฐ VM"
echo "===================================="

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
export POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-tprep_password}

echo "๐ POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}"

# ะะตัะตัะพะดะธะผ ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
cd /opt/t-prep

# ะัะฟะพะปะฝัะตะผ ะผะธะณัะฐัะธะธ ั ะฟัะฐะฒะธะปัะฝัะผ ะฟะฐัะพะปะตะผ
echo "๐๏ธ  ะัะฟะพะปะฝัะตะผ ะผะธะณัะฐัะธะธ ั ะฟัะฐะฒะธะปัะฝัะผ ะฟะฐัะพะปะตะผ..."
export POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-tprep_password}
./scripts/migrate-db.sh

# ะัะพะฒะตััะตะผ ััะฐััั
echo "๐ ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ:"
docker compose -f docker-compose.prod.yml ps

# ะัะพะฒะตััะตะผ API
echo "๐ ะัะพะฒะตััะตะผ API..."
if curl -f http://localhost/health > /dev/null 2>&1; then
    echo "โ API ัะฐะฑะพัะฐะตั!"
else
    echo "โ API ะฝะต ะพัะฒะตัะฐะตั"
    echo "๐ ะะพะณะธ:"
    docker compose -f docker-compose.prod.yml logs web --tail=20
fi

echo "๐ ะัะฟัะฐะฒะปะตะฝะธะต ะทะฐะฒะตััะตะฝะพ!"
